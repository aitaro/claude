# Pull Request 上で失敗しているCIを修正するコマンド

このコマンドは指定したPull Request 上で失敗しているCIを修正し、pushします。

## 使用方法

```
/fix-pr-ci <pr-number|pr-url> [追加の指示]
```

例:
- `/fix-pr-ci 1234`
- `/fix-pr-ci https://github.com/owner/repo/pull/1234`
- `/fix-pr-ci 1234 lintエラーのみ修正`
- `/fix-pr-ci 1234 テストも追加`

## 実行内容

1. **PR情報の取得**

   - `gh pr view <pr-number>` でPR情報を取得
   - ブランチ名、CI状態、失敗している項目を確認
   - 関連するLinearタスクがあれば取得

2. **ブランチへの切り替え**

   ```bash
   gh pr checkout <pr-number>
   git pull origin <branch-name>
   ```

3. **CI失敗の原因調査**

   - GitHub ActionsのログをMCP経由で取得
   - エラーメッセージとスタックトレースを分析
   - 失敗しているテスト、lint、型チェックを特定

4. **修正の実施**

   **よくあるCI失敗と対処法:**
   - **Lintエラー**: `npm run lint:fix` または手動修正
   - **型エラー**: TypeScriptエラーを修正
   - **テスト失敗**: テストコードまたは実装を修正
   - **ビルドエラー**: 依存関係や設定を確認
   - **フォーマットエラー**: `npm run format` を実行

5. **ローカルでの検証**

   ```bash
   npm run lint
   npm run typecheck
   npm test
   npm run build
   ```

6. **修正をコミット＆プッシュ**

   - 修正内容に応じたコミットメッセージを生成
   - `git add` と `git commit`
   - `git push origin <branch-name>`

7. **CI結果の確認**

   - プッシュ後のCI状態を監視
   - 新たなエラーが発生した場合は再度修正
   - すべてのチェックがグリーンになるまで繰り返す

## 自動判定ロジック

1. **エラーパターンの認識**
   - ESLintの警告/エラーパターン
   - TypeScriptの型エラーパターン
   - Jestのテスト失敗パターン
   - ビルドエラーのパターン

2. **修正戦略の決定**
   - エラーの種類に応じた最適な修正方法を選択
   - 自動修正可能なものは自動で実行
   - 手動修正が必要なものは適切に実装

3. **追加の指示への対応**
   - 特定のエラーのみ修正
   - テストの追加や改善
   - リファクタリングの実施

## 必要な設定

1. **GitHub CLI (gh)**
   - `gh` コマンドが使用可能であること
   - リポジトリへのアクセス権限があること

2. **開発環境**
   - Node.js/npm または該当する開発環境
   - プロジェクトの依存関係がインストール済み

3. **MCP接続**
   - GitHub Actions のログ取得用
   - Linear連携（オプション）

## オプション

- `--lint-only`: Lintエラーのみ修正
- `--test-only`: テストエラーのみ修正
- `--type-only`: 型エラーのみ修正
- `--no-verify`: ローカル検証をスキップ
- `--force-push`: 強制プッシュ（注意して使用）

## エラーハンドリング

- CI設定が見つからない場合はユーザーに確認
- 修正が困難な場合は詳細な説明を提供
- コンフリクトが発生した場合は解消をサポート
- 権限がない場合は適切なエラーメッセージを表示